<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>RewardService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">project</a> &gt; <a href="index.source.html" class="el_package">com.example.budgettracker.service</a> &gt; <span class="el_source">RewardService.java</span></div><h1>RewardService.java</h1><pre class="source lang-java linenums">package com.example.budgettracker.service;

import com.example.budgettracker.dto.Budgetcoin.RewardGrantRequest;
import com.example.budgettracker.dto.Budgetcoin.RewardGrantResponse;
import com.example.budgettracker.dto.Budgetcoin.RewardRedeemRequest;
import com.example.budgettracker.dto.Budgetcoin.RewardRedeemResponse;
import com.example.budgettracker.dto.Budgetcoin.RewardTransactionResponse;
import com.example.budgettracker.model.Item;
import com.example.budgettracker.model.RewardGrant;
import com.example.budgettracker.model.RewardRedeem;
import com.example.budgettracker.model.User;
import com.example.budgettracker.repository.ItemRepository;
import com.example.budgettracker.repository.RewardGrantRepository;
import com.example.budgettracker.repository.RewardRedeemRepository;
import com.example.budgettracker.repository.UserRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.math.BigDecimal;
import java.util.Comparator;
import java.util.List;
import java.util.UUID;
import java.util.stream.Collectors;
import java.util.stream.Stream;

@Service
@RequiredArgsConstructor
public class RewardService {

    private final UserRepository userRepository;
    private final RewardGrantRepository rewardGrantRepository;
    private final RewardRedeemRepository rewardRedeemRepository;
    private final ItemRepository itemRepository;

    public BigDecimal getBalance(Long userId) {
<span class="fc" id="L37">        User user = userRepository.findById(userId)</span>
<span class="fc" id="L38">                .orElseThrow(() -&gt; new RuntimeException(&quot;User not found&quot;));</span>
<span class="fc bfc" id="L39" title="All 2 branches covered.">        return user.getBudgetCoin() != null ? BigDecimal.valueOf(user.getBudgetCoin()) : BigDecimal.ZERO;</span>
    }

    @Transactional
    public RewardGrantResponse grantBudgetCoin(RewardGrantRequest request) {
<span class="fc" id="L44">        User user = userRepository.findById(request.getUserId())</span>
<span class="fc" id="L45">                .orElseThrow(() -&gt; new RuntimeException(&quot;User not found&quot;));</span>

<span class="pc bpc" id="L47" title="2 of 4 branches missed.">        if (request.getAmount() == null || request.getAmount().compareTo(BigDecimal.ZERO) &lt;= 0) {</span>
<span class="nc" id="L48">            throw new IllegalArgumentException(&quot;Grant amount must be positive&quot;);</span>
        }

<span class="fc" id="L51">        String sourceType = request.getSourceType();</span>
<span class="pc bpc" id="L52" title="2 of 4 branches missed.">        if (sourceType == null || sourceType.isBlank()) {</span>
<span class="nc" id="L53">            sourceType = &quot;General&quot;;</span>
        }

<span class="fc" id="L56">        String rewardEventId = request.getRewardEventId();</span>
<span class="pc bpc" id="L57" title="2 of 4 branches missed.">        if (rewardEventId == null || rewardEventId.isBlank()) {</span>
<span class="nc" id="L58">            rewardEventId = UUID.randomUUID().toString();</span>
        }

<span class="fc" id="L61">        RewardGrant grant = RewardGrant.builder()</span>
<span class="fc" id="L62">                .user(user)</span>
<span class="fc" id="L63">                .amount(request.getAmount())</span>
<span class="fc" id="L64">                .sourceType(sourceType)</span>
<span class="fc" id="L65">                .rewardEventId(rewardEventId)</span>
<span class="fc" id="L66">                .build();</span>

<span class="pc bpc" id="L68" title="1 of 2 branches missed.">        long currentBalance = user.getBudgetCoin() != null ? user.getBudgetCoin() : 0L;</span>
<span class="fc" id="L69">        long newBalance = currentBalance + request.getAmount().longValue();</span>
<span class="fc" id="L70">        user.setBudgetCoin(newBalance);</span>
<span class="fc" id="L71">        userRepository.save(user);</span>

<span class="fc" id="L73">        RewardGrant saved = rewardGrantRepository.save(grant);</span>

<span class="fc" id="L75">        return new RewardGrantResponse(</span>
<span class="fc" id="L76">                saved.getGrantId(),</span>
<span class="fc" id="L77">                user.getUserId(),</span>
<span class="fc" id="L78">                saved.getAmount(),</span>
<span class="fc" id="L79">                saved.getSourceType(),</span>
<span class="fc" id="L80">                saved.getRewardEventId(),</span>
<span class="fc" id="L81">                saved.getCreatedAt(),</span>
<span class="fc" id="L82">                newBalance</span>
        );
    }

    @Transactional
    public RewardRedeemResponse redeemBudgetCoin(RewardRedeemRequest request) {
<span class="fc" id="L88">        User user = userRepository.findById(request.getUserId())</span>
<span class="fc" id="L89">                .orElseThrow(() -&gt; new RuntimeException(&quot;User not found&quot;));</span>

<span class="fc" id="L91">        Item item = itemRepository.findById(request.getItemId())</span>
<span class="fc" id="L92">                .orElseThrow(() -&gt; new RuntimeException(&quot;Item not found&quot;));</span>

<span class="pc bpc" id="L94" title="1 of 2 branches missed.">        long currentBalance = user.getBudgetCoin() != null ? user.getBudgetCoin() : 0L;</span>
<span class="fc bfc" id="L95" title="All 2 branches covered.">        if (currentBalance &lt; item.getPrice()) {</span>
<span class="fc" id="L96">            throw new RuntimeException(&quot;Insufficient BudgetCoin balance&quot;);</span>
        }

<span class="fc bfc" id="L99" title="All 2 branches covered.">        if (item.getStockQty() &lt;= 0) {</span>
<span class="fc" id="L100">            throw new RuntimeException(&quot;Item out of stock&quot;);</span>
        }

<span class="fc" id="L103">        long newBalance = currentBalance - item.getPrice();</span>
<span class="fc" id="L104">        user.setBudgetCoin(newBalance);</span>
<span class="fc" id="L105">        userRepository.save(user);</span>

<span class="fc" id="L107">        item.setStockQty(item.getStockQty() - 1);</span>
<span class="fc" id="L108">        itemRepository.save(item);</span>

<span class="fc" id="L110">        RewardRedeem redeem = RewardRedeem.builder()</span>
<span class="fc" id="L111">                .user(user)</span>
<span class="fc" id="L112">                .item(item)</span>
<span class="fc" id="L113">                .amount(BigDecimal.valueOf(item.getPrice()))</span>
<span class="fc" id="L114">                .itemName(item.getItemName())</span>
<span class="fc" id="L115">                .build();</span>

<span class="fc" id="L117">        RewardRedeem saved = rewardRedeemRepository.save(redeem);</span>

<span class="fc" id="L119">        return new RewardRedeemResponse(</span>
<span class="fc" id="L120">                saved.getOrderId(),</span>
<span class="fc" id="L121">                user.getUserId(),</span>
<span class="fc" id="L122">                item.getItemId(),</span>
<span class="fc" id="L123">                item.getItemName(),</span>
<span class="fc" id="L124">                saved.getAmount(),</span>
<span class="fc" id="L125">                saved.getRedeemedAt(),</span>
<span class="fc" id="L126">                newBalance</span>
        );
    }

    public List&lt;RewardGrantResponse&gt; getGrants(Long userId) {
<span class="fc" id="L131">        return rewardGrantRepository.findByUserUserId(userId)</span>
<span class="fc" id="L132">                .stream()</span>
<span class="fc" id="L133">                .map(g -&gt; new RewardGrantResponse(</span>
<span class="fc" id="L134">                        g.getGrantId(),</span>
<span class="fc" id="L135">                        g.getUser().getUserId(),</span>
<span class="fc" id="L136">                        g.getAmount(),</span>
<span class="fc" id="L137">                        g.getSourceType(),</span>
<span class="fc" id="L138">                        g.getRewardEventId(),</span>
<span class="fc" id="L139">                        g.getCreatedAt(),</span>
                        null
                ))
<span class="fc" id="L142">                .collect(Collectors.toList());</span>
    }

    public List&lt;RewardRedeemResponse&gt; getRedeems(Long userId) {
<span class="fc" id="L146">        return rewardRedeemRepository.findByUserUserId(userId)</span>
<span class="fc" id="L147">                .stream()</span>
<span class="fc" id="L148">                .map(r -&gt; new RewardRedeemResponse(</span>
<span class="fc" id="L149">                        r.getOrderId(),</span>
<span class="fc" id="L150">                        r.getUser().getUserId(),</span>
<span class="fc" id="L151">                        r.getItem().getItemId(),</span>
<span class="fc" id="L152">                        r.getItemName(),</span>
<span class="fc" id="L153">                        r.getAmount(),</span>
<span class="fc" id="L154">                        r.getRedeemedAt(),</span>
                        null
                ))
<span class="fc" id="L157">                .collect(Collectors.toList());</span>
    }

    public List&lt;RewardTransactionResponse&gt; getTransactionHistory(Long userId) {
<span class="fc" id="L161">        List&lt;RewardGrant&gt; grants = rewardGrantRepository.findByUserUserId(userId);</span>
<span class="fc" id="L162">        List&lt;RewardRedeem&gt; redeems = rewardRedeemRepository.findByUserUserId(userId);</span>

<span class="fc" id="L164">        return Stream.concat(</span>
<span class="fc" id="L165">                        grants.stream()</span>
<span class="fc" id="L166">                                .map(g -&gt; new RewardTransactionResponse(</span>
                                        &quot;EARN&quot;,
<span class="fc" id="L168">                                        g.getSourceType(),</span>
<span class="fc" id="L169">                                        g.getRewardEventId(),</span>
<span class="fc" id="L170">                                        g.getAmount(),</span>
<span class="fc" id="L171">                                        g.getCreatedAt()</span>
                                )),
<span class="fc" id="L173">                        redeems.stream()</span>
<span class="fc" id="L174">                                .map(r -&gt; new RewardTransactionResponse(</span>
                                        &quot;SPEND&quot;,
<span class="fc" id="L176">                                        r.getItemName(),</span>
<span class="fc" id="L177">                                        String.valueOf(r.getOrderId()),</span>
<span class="fc" id="L178">                                        r.getAmount(),</span>
<span class="fc" id="L179">                                        r.getRedeemedAt()</span>
                                ))
                )
<span class="fc" id="L182">                .sorted(Comparator.comparing(RewardTransactionResponse::getOccurredAt).reversed())</span>
<span class="fc" id="L183">                .collect(Collectors.toList());</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>