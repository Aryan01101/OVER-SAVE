<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DashboardController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">project</a> &gt; <a href="index.source.html" class="el_package">com.example.budgettracker.controller</a> &gt; <span class="el_source">DashboardController.java</span></div><h1>DashboardController.java</h1><pre class="source lang-java linenums">package com.example.budgettracker.controller;

import com.example.budgettracker.dto.Dashboard.DashboardResponse;
import com.example.budgettracker.dto.Dashboard.FinancialAggregatesResponse;
import com.example.budgettracker.dto.Dashboard.SpendingTrendData;
import com.example.budgettracker.model.User;
import com.example.budgettracker.service.AuthService;
import com.example.budgettracker.service.DashboardService;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.util.HashMap;
import java.util.Map;

/**
 * FR-14: Dashboard Controller
 * Provides REST endpoints for dashboard data
 */
@RestController
@RequestMapping(&quot;/api/dashboard&quot;)
@RequiredArgsConstructor
<span class="nc" id="L25">@Slf4j</span>
public class DashboardController {

    private final DashboardService dashboardService;
    private final AuthService authService;

    /**
     * FR-14: Get complete dashboard data
     * GET /api/dashboard
     */
    @GetMapping
    public ResponseEntity&lt;?&gt; getDashboardData(@RequestHeader(&quot;Authorization&quot;) String authHeader) {
        try {
<span class="nc bnc" id="L38" title="All 2 branches missed.">            log.debug(&quot;üîê FR-14: Received Authorization header: {}&quot;, authHeader != null ? authHeader.substring(0, Math.min(20, authHeader.length())) + &quot;...&quot; : &quot;NULL&quot;);</span>

<span class="nc" id="L40">            Long userId = getUserIdFromToken(authHeader);</span>

<span class="nc" id="L42">            log.debug(&quot;üîê FR-14: Extracted userId: {}&quot;, userId);</span>

<span class="nc bnc" id="L44" title="All 2 branches missed.">            if (userId == null) {</span>
<span class="nc" id="L45">                log.warn(&quot;‚ö†Ô∏è FR-14: User not authenticated - Authorization header: {}&quot;,</span>
<span class="nc bnc" id="L46" title="All 2 branches missed.">                         authHeader != null ? authHeader.substring(0, Math.min(20, authHeader.length())) + &quot;...&quot; : &quot;NULL&quot;);</span>
<span class="nc" id="L47">                return ResponseEntity.status(HttpStatus.UNAUTHORIZED)</span>
<span class="nc" id="L48">                        .body(createErrorResponse(&quot;User not authenticated&quot;));</span>
            }

<span class="nc" id="L51">            log.info(&quot;FR-14: Fetching dashboard data for user {}&quot;, userId);</span>
<span class="nc" id="L52">            DashboardResponse response = dashboardService.getDashboardData(userId);</span>

            // FR-14: Handle data unavailability
<span class="nc bnc" id="L55" title="All 2 branches missed.">            if (!response.isDataAvailable()) {</span>
<span class="nc" id="L56">                return ResponseEntity.status(HttpStatus.SERVICE_UNAVAILABLE)</span>
<span class="nc" id="L57">                        .body(response);</span>
            }

<span class="nc" id="L60">            return ResponseEntity.ok(response);</span>

<span class="nc" id="L62">        } catch (Exception e) {</span>
<span class="nc" id="L63">            log.error(&quot;FR-14: Error in getDashboardData&quot;, e);</span>
<span class="nc" id="L64">            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)</span>
<span class="nc" id="L65">                        .body(createErrorResponse(&quot;Failed to load dashboard data. Please try again.&quot;));</span>
        }
    }

    /**
     * FR-14: Get financial aggregates only
     * GET /api/dashboard/financial-aggregates
     */
    @GetMapping(&quot;/financial-aggregates&quot;)
    public ResponseEntity&lt;?&gt; getFinancialAggregates(@RequestHeader(&quot;Authorization&quot;) String authHeader) {
        try {
<span class="nc" id="L76">            Long userId = getUserIdFromToken(authHeader);</span>
<span class="nc bnc" id="L77" title="All 2 branches missed.">            if (userId == null) {</span>
<span class="nc" id="L78">                return ResponseEntity.status(HttpStatus.UNAUTHORIZED)</span>
<span class="nc" id="L79">                        .body(createErrorResponse(&quot;User not authenticated&quot;));</span>
            }

<span class="nc" id="L82">            log.info(&quot;FR-14: Fetching financial aggregates for user {}&quot;, userId);</span>
<span class="nc" id="L83">            FinancialAggregatesResponse response = dashboardService.getFinancialAggregates(userId);</span>

<span class="nc" id="L85">            return ResponseEntity.ok(response);</span>

<span class="nc" id="L87">        } catch (Exception e) {</span>
<span class="nc" id="L88">            log.error(&quot;FR-14: Error in getFinancialAggregates&quot;, e);</span>
<span class="nc" id="L89">            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)</span>
<span class="nc" id="L90">                        .body(createErrorResponse(&quot;Failed to load financial data.&quot;));</span>
        }
    }

    /**
     * FR-14: Get spending trend data for charts
     * GET /api/dashboard/spending-trend?period=week
     * @param period &quot;WEEK&quot;, &quot;MONTH&quot;, or &quot;YEAR&quot;
     */
    @GetMapping(&quot;/spending-trend&quot;)
    public ResponseEntity&lt;?&gt; getSpendingTrend(
            @RequestParam(defaultValue = &quot;WEEK&quot;) String period,
            @RequestHeader(&quot;Authorization&quot;) String authHeader) {
        try {
<span class="nc" id="L104">            Long userId = getUserIdFromToken(authHeader);</span>
<span class="nc bnc" id="L105" title="All 2 branches missed.">            if (userId == null) {</span>
<span class="nc" id="L106">                return ResponseEntity.status(HttpStatus.UNAUTHORIZED)</span>
<span class="nc" id="L107">                        .body(createErrorResponse(&quot;User not authenticated&quot;));</span>
            }

<span class="nc" id="L110">            log.info(&quot;FR-14: Fetching spending trend for user {} with period {}&quot;, userId, period);</span>
<span class="nc" id="L111">            SpendingTrendData response = dashboardService.getSpendingTrend(userId, period);</span>

<span class="nc" id="L113">            return ResponseEntity.ok(response);</span>

<span class="nc" id="L115">        } catch (Exception e) {</span>
<span class="nc" id="L116">            log.error(&quot;FR-14: Error in getSpendingTrend&quot;, e);</span>
<span class="nc" id="L117">            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)</span>
<span class="nc" id="L118">                        .body(createErrorResponse(&quot;Failed to load spending trend.&quot;));</span>
        }
    }

    /**
     * Extract userId from session token
     */
    private Long getUserIdFromToken(String authHeader) {
<span class="nc" id="L126">        String sessionToken = extractSessionToken(authHeader);</span>
<span class="nc bnc" id="L127" title="All 2 branches missed.">        log.debug(&quot;üîê FR-14: Extracted session token: {}&quot;, sessionToken != null ? sessionToken.substring(0, Math.min(10, sessionToken.length())) + &quot;...&quot; : &quot;NULL&quot;);</span>

<span class="nc bnc" id="L129" title="All 2 branches missed.">        if (sessionToken == null) {</span>
<span class="nc" id="L130">            log.warn(&quot;‚ö†Ô∏è FR-14: No session token found in Authorization header&quot;);</span>
<span class="nc" id="L131">            return null;</span>
        }

<span class="nc" id="L134">        User user = authService.getCurrentUser(sessionToken);</span>
<span class="nc bnc" id="L135" title="All 2 branches missed.">        log.debug(&quot;üîê FR-14: Retrieved user from session: {}&quot;, user != null ? user.getEmail() : &quot;NULL&quot;);</span>

<span class="nc bnc" id="L137" title="All 2 branches missed.">        return user != null ? user.getUserId() : null;</span>
    }

    /**
     * Extract session token from Authorization header
     */
    private String extractSessionToken(String authHeader) {
<span class="nc bnc" id="L144" title="All 4 branches missed.">        if (authHeader != null &amp;&amp; authHeader.startsWith(&quot;Bearer &quot;)) {</span>
<span class="nc" id="L145">            return authHeader.substring(7);</span>
        }
<span class="nc" id="L147">        return null;</span>
    }

    /**
     * FR-14: Helper method to create error response with fallback message
     */
    private Map&lt;String, Object&gt; createErrorResponse(String message) {
<span class="nc" id="L154">        Map&lt;String, Object&gt; error = new HashMap&lt;&gt;();</span>
<span class="nc" id="L155">        error.put(&quot;dataAvailable&quot;, false);</span>
<span class="nc" id="L156">        error.put(&quot;message&quot;, message);</span>
<span class="nc" id="L157">        error.put(&quot;timestamp&quot;, System.currentTimeMillis());</span>
<span class="nc" id="L158">        return error;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>