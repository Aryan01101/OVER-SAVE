<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PasswordResetController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">project</a> &gt; <a href="index.source.html" class="el_package">com.example.budgettracker.controller</a> &gt; <span class="el_source">PasswordResetController.java</span></div><h1>PasswordResetController.java</h1><pre class="source lang-java linenums">package com.example.budgettracker.controller;

import com.example.budgettracker.dto.PasswordResetRequest;
import com.example.budgettracker.dto.PasswordResetResponse;
import com.example.budgettracker.service.PasswordResetService;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.validation.Valid;
import jakarta.validation.constraints.Email;
import jakarta.validation.constraints.NotBlank;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.util.Map;

/**
 * FR-05: Password Reset Controller
 * Handles password reset requests with 15-minute token expiry
 */
@RestController
@RequestMapping(&quot;/api/auth&quot;)
@RequiredArgsConstructor
<span class="nc" id="L24">@Slf4j</span>
public class PasswordResetController {

    private final PasswordResetService passwordResetService;

    /**
     * POST /api/auth/forgot-password
     * Request password reset - always returns success to prevent email enumeration
     */
    @PostMapping(&quot;/forgot-password&quot;)
    public ResponseEntity&lt;PasswordResetResponse&gt; forgotPassword(
            @Valid @RequestBody ForgotPasswordRequest request,
            HttpServletRequest httpRequest) {

<span class="nc" id="L38">        String ipAddress = getClientIpAddress(httpRequest);</span>
<span class="nc" id="L39">        log.info(&quot;Password reset requested for email: {} from IP: {}&quot;, request.getEmail(), ipAddress);</span>

<span class="nc" id="L41">        PasswordResetResponse response = passwordResetService.requestReset(request.getEmail());</span>
<span class="nc" id="L42">        return ResponseEntity.ok(response);</span>
    }

    /**
     * GET /api/auth/reset-password/:token
     * Validate reset token (for frontend to check before showing reset form)
     */
    @GetMapping(&quot;/reset-password/{token}&quot;)
    public ResponseEntity&lt;PasswordResetResponse&gt; validateResetToken(@PathVariable String token) {
<span class="nc" id="L51">        log.info(&quot;Token validation requested for token: {}&quot;, maskToken(token));</span>

<span class="nc" id="L53">        PasswordResetResponse response = passwordResetService.validateToken(token);</span>

<span class="nc bnc" id="L55" title="All 2 branches missed.">        if (response.isSuccess()) {</span>
<span class="nc" id="L56">            return ResponseEntity.ok(response);</span>
        } else {
<span class="nc" id="L58">            return ResponseEntity.badRequest().body(response);</span>
        }
    }

    /**
     * POST /api/auth/reset-password
     * Reset password using token
     */
    @PostMapping(&quot;/reset-password&quot;)
    public ResponseEntity&lt;PasswordResetResponse&gt; resetPassword(
            @Valid @RequestBody ResetPasswordRequest request,
            HttpServletRequest httpRequest) {

<span class="nc" id="L71">        String ipAddress = getClientIpAddress(httpRequest);</span>
<span class="nc" id="L72">        log.info(&quot;Password reset attempt for token: {} from IP: {}&quot;, maskToken(request.getToken()), ipAddress);</span>

<span class="nc" id="L74">        PasswordResetResponse response = passwordResetService.resetPassword(</span>
<span class="nc" id="L75">                request.getToken(),</span>
<span class="nc" id="L76">                request.getNewPassword()</span>
        );

<span class="nc bnc" id="L79" title="All 2 branches missed.">        if (response.isSuccess()) {</span>
<span class="nc" id="L80">            return ResponseEntity.ok(response);</span>
        } else {
<span class="nc" id="L82">            return ResponseEntity.badRequest().body(response);</span>
        }
    }

    /**
     * POST /api/auth/validate-password
     * Validate password strength (for frontend validation)
     */
    @PostMapping(&quot;/validate-password&quot;)
    public ResponseEntity&lt;PasswordResetResponse&gt; validatePassword(@RequestBody Map&lt;String, String&gt; request) {
<span class="nc" id="L92">        String password = request.get(&quot;password&quot;);</span>

<span class="nc" id="L94">        PasswordResetResponse response = passwordResetService.validatePasswordStrength(password);</span>
<span class="nc" id="L95">        return ResponseEntity.ok(response);</span>
    }

    private String getClientIpAddress(HttpServletRequest request) {
<span class="nc" id="L99">        String xForwardedFor = request.getHeader(&quot;X-Forwarded-For&quot;);</span>
<span class="nc bnc" id="L100" title="All 4 branches missed.">        if (xForwardedFor != null &amp;&amp; !xForwardedFor.isEmpty()) {</span>
<span class="nc" id="L101">            return xForwardedFor.split(&quot;,&quot;)[0].trim();</span>
        }

<span class="nc" id="L104">        String xRealIp = request.getHeader(&quot;X-Real-IP&quot;);</span>
<span class="nc bnc" id="L105" title="All 4 branches missed.">        if (xRealIp != null &amp;&amp; !xRealIp.isEmpty()) {</span>
<span class="nc" id="L106">            return xRealIp;</span>
        }

<span class="nc" id="L109">        return request.getRemoteAddr();</span>
    }

    private String maskToken(String token) {
<span class="nc bnc" id="L113" title="All 4 branches missed.">        if (token == null || token.length() &lt; 8) {</span>
<span class="nc" id="L114">            return &quot;***&quot;;</span>
        }
<span class="nc" id="L116">        return token.substring(0, 4) + &quot;***&quot; + token.substring(token.length() - 4);</span>
    }

    // Inner DTOs for this controller
<span class="nc" id="L120">    public static class ForgotPasswordRequest {</span>
        @Email(message = &quot;Please provide a valid email address&quot;)
        @NotBlank(message = &quot;Email is required&quot;)
        private String email;

<span class="nc" id="L125">        public String getEmail() { return email; }</span>
<span class="nc" id="L126">        public void setEmail(String email) { this.email = email; }</span>
    }

<span class="nc" id="L129">    public static class ResetPasswordRequest {</span>
        @NotBlank(message = &quot;Token is required&quot;)
        private String token;

        @NotBlank(message = &quot;New password is required&quot;)
        private String newPassword;

<span class="nc" id="L136">        public String getToken() { return token; }</span>
<span class="nc" id="L137">        public void setToken(String token) { this.token = token; }</span>
<span class="nc" id="L138">        public String getNewPassword() { return newPassword; }</span>
<span class="nc" id="L139">        public void setNewPassword(String newPassword) { this.newPassword = newPassword; }</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>