<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>OAuth2AuthenticationSuccessHandler.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">project</a> &gt; <a href="index.source.html" class="el_package">com.example.budgettracker.config</a> &gt; <span class="el_source">OAuth2AuthenticationSuccessHandler.java</span></div><h1>OAuth2AuthenticationSuccessHandler.java</h1><pre class="source lang-java linenums">package com.example.budgettracker.config;

import com.example.budgettracker.model.Account;
import com.example.budgettracker.model.Session;
import com.example.budgettracker.model.User;
import com.example.budgettracker.model.enums.AccountType;
import com.example.budgettracker.repository.AccountRepository;
import com.example.budgettracker.repository.UserRepository;
import com.example.budgettracker.service.SessionManagementService;
import jakarta.servlet.ServletException;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.security.core.Authentication;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.security.oauth2.core.user.OAuth2User;
import org.springframework.security.web.authentication.SimpleUrlAuthenticationSuccessHandler;
import org.springframework.stereotype.Component;

import java.io.IOException;
import java.security.SecureRandom;
import java.util.Base64;
import java.util.Optional;

/**
 * Custom success handler for OAuth2 authentication
 * Handles user creation/login and session management after successful Google OAuth
 */
@Component
@RequiredArgsConstructor
<span class="nc" id="L33">@Slf4j</span>
public class OAuth2AuthenticationSuccessHandler extends SimpleUrlAuthenticationSuccessHandler {

    private final UserRepository userRepository;
    private final AccountRepository accountRepository;
    private final SessionManagementService sessionManagementService;
    private final PasswordEncoder passwordEncoder;

    @Value(&quot;${app.frontend.url:http://localhost:8080}&quot;)
    private String frontendUrl;

    @Override
    public void onAuthenticationSuccess(HttpServletRequest request,
                                       HttpServletResponse response,
                                       Authentication authentication) throws IOException, ServletException {

<span class="nc" id="L49">        OAuth2User oAuth2User = (OAuth2User) authentication.getPrincipal();</span>

        try {
            // Extract user info from Google
<span class="nc" id="L53">            String email = oAuth2User.getAttribute(&quot;email&quot;);</span>
<span class="nc" id="L54">            String googleId = oAuth2User.getAttribute(&quot;sub&quot;); // Google's unique user ID</span>
<span class="nc" id="L55">            String firstName = oAuth2User.getAttribute(&quot;given_name&quot;);</span>
<span class="nc" id="L56">            String lastName = oAuth2User.getAttribute(&quot;family_name&quot;);</span>
<span class="nc" id="L57">            String profilePictureUrl = oAuth2User.getAttribute(&quot;picture&quot;);</span>

<span class="nc" id="L59">            log.info(&quot;OAuth2 login attempt for email: {}&quot;, email);</span>

            // Find or create user
<span class="nc" id="L62">            User user = findOrCreateUser(email, googleId, firstName, lastName, profilePictureUrl);</span>

            // Create session
<span class="nc" id="L65">            String ipAddress = getClientIpAddress(request);</span>
<span class="nc" id="L66">            String userAgent = request.getHeader(&quot;User-Agent&quot;);</span>
<span class="nc" id="L67">            Session session = sessionManagementService.createSession(user, ipAddress, userAgent);</span>

<span class="nc" id="L69">            log.info(&quot;User {} logged in successfully via Google OAuth&quot;, user.getEmail());</span>

            // Redirect to dashboard with session token
<span class="nc" id="L72">            String redirectUrl = String.format(&quot;%s/html/oversave-dashboard.html?sessionToken=%s&amp;userId=%d&amp;email=%s&amp;firstName=%s&amp;lastName=%s&quot;,</span>
                frontendUrl,
<span class="nc" id="L74">                session.getSessionToken(),</span>
<span class="nc" id="L75">                user.getUserId(),</span>
<span class="nc" id="L76">                user.getEmail(),</span>
<span class="nc" id="L77">                user.getFirstName(),</span>
<span class="nc" id="L78">                user.getLastName()</span>
            );

<span class="nc" id="L81">            getRedirectStrategy().sendRedirect(request, response, redirectUrl);</span>

<span class="nc" id="L83">        } catch (Exception e) {</span>
<span class="nc" id="L84">            log.error(&quot;Error during OAuth2 authentication&quot;, e);</span>

            // Redirect to login with error
<span class="nc" id="L87">            String errorUrl = frontendUrl + &quot;/login.html?error=oauth_failed&quot;;</span>
<span class="nc" id="L88">            getRedirectStrategy().sendRedirect(request, response, errorUrl);</span>
<span class="nc" id="L89">        }</span>
<span class="nc" id="L90">    }</span>

    private User findOrCreateUser(String email, String googleId, String firstName,
                                 String lastName, String profilePictureUrl) {
        // Try to find existing user by email
<span class="nc" id="L95">        Optional&lt;User&gt; existingUser = userRepository.findByEmail(email);</span>

<span class="nc bnc" id="L97" title="All 2 branches missed.">        if (existingUser.isPresent()) {</span>
<span class="nc" id="L98">            User user = existingUser.get();</span>

            // Update Google ID and profile picture if not set
<span class="nc" id="L101">            boolean needsUpdate = false;</span>

<span class="nc bnc" id="L103" title="All 4 branches missed.">            if (user.getGoogleId() == null || !user.getGoogleId().equals(googleId)) {</span>
<span class="nc" id="L104">                user.setGoogleId(googleId);</span>
<span class="nc" id="L105">                needsUpdate = true;</span>
            }

<span class="nc bnc" id="L108" title="All 4 branches missed.">            if (profilePictureUrl != null &amp;&amp; !profilePictureUrl.equals(user.getProfilePictureUrl())) {</span>
<span class="nc" id="L109">                user.setProfilePictureUrl(profilePictureUrl);</span>
<span class="nc" id="L110">                needsUpdate = true;</span>
            }

<span class="nc bnc" id="L113" title="All 2 branches missed.">            if (needsUpdate) {</span>
<span class="nc" id="L114">                user = userRepository.save(user);</span>
<span class="nc" id="L115">                log.info(&quot;Updated existing user {} with Google OAuth info&quot;, email);</span>
            }

<span class="nc" id="L118">            return user;</span>
        }

        // Create new user
<span class="nc" id="L122">        User newUser = User.builder()</span>
<span class="nc" id="L123">            .email(email)</span>
<span class="nc" id="L124">            .googleId(googleId)</span>
<span class="nc" id="L125">            .hashedPassword(generateRandomPassword()) // Random password for OAuth users</span>
<span class="nc bnc" id="L126" title="All 2 branches missed.">            .firstName(firstName != null ? firstName : &quot;User&quot;)</span>
<span class="nc bnc" id="L127" title="All 2 branches missed.">            .lastName(lastName != null ? lastName : &quot;&quot;)</span>
<span class="nc" id="L128">            .profilePictureUrl(profilePictureUrl)</span>
<span class="nc" id="L129">            .allowNotificationEmail(false)</span>
<span class="nc" id="L130">            .budgetCoin(0L)</span>
<span class="nc" id="L131">            .build();</span>

<span class="nc" id="L133">        newUser = userRepository.save(newUser);</span>
<span class="nc" id="L134">        log.info(&quot;Created new user via Google OAuth: {}&quot;, email);</span>

        // Create default CASH account
<span class="nc" id="L137">        Account cashAccount = Account.builder()</span>
<span class="nc" id="L138">            .user(newUser)</span>
<span class="nc" id="L139">            .name(&quot;Cash Account&quot;)</span>
<span class="nc" id="L140">            .accountType(AccountType.CASH)</span>
<span class="nc" id="L141">            .build();</span>
<span class="nc" id="L142">        accountRepository.save(cashAccount);</span>
<span class="nc" id="L143">        log.info(&quot;Created default CASH account for new OAuth user: {}&quot;, email);</span>

<span class="nc" id="L145">        return newUser;</span>
    }

    private String generateRandomPassword() {
        // Generate secure random password for OAuth users
        // They won't use it, but database requires a value
<span class="nc" id="L151">        byte[] randomBytes = new byte[32];</span>
<span class="nc" id="L152">        new SecureRandom().nextBytes(randomBytes);</span>
<span class="nc" id="L153">        String randomPassword = Base64.getEncoder().encodeToString(randomBytes);</span>
<span class="nc" id="L154">        return passwordEncoder.encode(randomPassword);</span>
    }

    private String getClientIpAddress(HttpServletRequest request) {
<span class="nc" id="L158">        String xForwardedFor = request.getHeader(&quot;X-Forwarded-For&quot;);</span>
<span class="nc bnc" id="L159" title="All 4 branches missed.">        if (xForwardedFor != null &amp;&amp; !xForwardedFor.isEmpty()) {</span>
<span class="nc" id="L160">            return xForwardedFor.split(&quot;,&quot;)[0].trim();</span>
        }

<span class="nc" id="L163">        String xRealIp = request.getHeader(&quot;X-Real-IP&quot;);</span>
<span class="nc bnc" id="L164" title="All 4 branches missed.">        if (xRealIp != null &amp;&amp; !xRealIp.isEmpty()) {</span>
<span class="nc" id="L165">            return xRealIp;</span>
        }

<span class="nc" id="L168">        return request.getRemoteAddr();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>